{% extends 'game/base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'game/css/archive.css' %}">

<div class="container mt-5">
    {% now "Y-m-d" as today %}
    {% with "2024-05-20" as launch_date %}

        {% if selected_date %}
            {% if selected_date == today %}
                <div class="text-center mt-5">
                    <h3 class="text-warning neon-text-soft">Nice try üòâ But you can't play today's song here!</h3>
                    <a href="{% url 'archive' language=current_language|default:'tamil' %}" class="btn btn-secondary mt-3">Pick Another Date</a>
                </div>

            {% elif selected_date < launch_date %}
                <div class="text-center mt-5">
                    <h3 class="text-muted neon-text">Oops! SPOT-ify hadn‚Äôt even been born yet üöº</h3>
                    <p class="text-light">Please select a date on or after May 20, 2024.</p>
                    <a href="{% url 'archive' language=current_language|default:'tamil' %}" class="btn btn-secondary mt-3">Pick Another Date</a>
                </div>

            {% elif selected_song %}
                <div id="game-view">
                    <div class="archive-header mb-4">
                        <a href="{% url 'archive' language=current_language|default:'tamil' %}" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
                        <div class="archive-date-badge">
                            <i class="fas fa-calendar-alt"></i>
                            {{ selected_date|date:"F j, Y" }}
                        </div>
                    </div>

                    <div class="game-header">
                        <div class="timer" id="timer">00:00</div>
                        <div class="points-indicator">+<span class="points-value">8</span></div>
                    </div>

                    <div class="archive-player text-center mb-4">
                        <audio id="song-snippet" preload="auto">
                            {% if selected_song.snippet %}
                                <source src="{{ selected_song.snippet.url }}" type="audio/mpeg">
                            {% else %}
                                Your browser does not support the audio element.
                            {% endif %}
                        </audio>

                        <audio id="reveal-snippet" preload="auto">
                            {% if selected_song.reveal_snippet %}
                                <source src="{{ selected_song.reveal_snippet.url }}" type="audio/mpeg">
                            {% endif %}
                        </audio>

                        <div id="vinyl-player" class="vinyl paused mt-3" onclick="togglePlay()">
                            <i id="vinyl-play-icon" class="fas fa-play"></i>
                        </div>
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill"></div>
                            </div>
                        </div>
                        <div class="game-controls">
                            <button id="playPauseBtn" class="btn btn-play"><i class="fas fa-play"></i> Play</button>
                            <button id="giveUpBtn" class="btn btn-giveup"><i class="fas fa-times"></i> Give Up</button>
                        </div>
                    </div>

                    <form id="guess-form" class="guess-form">
                        {% csrf_token %}
                        <div class="form-group position-relative">
                            <input type="text" id="guess-input" class="form-control" placeholder="Type your guess..." autocomplete="off" data-spotify-id="">
                            <div id="suggestions" class="suggestions-container"></div>
                        </div>
                        <div class="text-center mt-3">
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                        <div id="result-message" class="mt-3"></div>
                    </form>
                </div>

                <div id="result-container" style="display: none;"></div>

            {% else %}
                <div class="text-center mt-5">
                    <h4 class="text-danger">Oops! No song found for this date.</h4>
                    <a href="{% url 'archive' language=current_language|default:'tamil' %}" class="btn btn-secondary mt-3">Try Another Date</a>
                </div>
            {% endif %}

        {% else %}
            <!-- No date selected yet -->
            <div class="archive-date-wrapper">
                <div class="archive-date-box">
                    <h3 class="mb-4">Select a Date to Play Archived Song</h3>
                    <form method="get" class="d-flex justify-content-center flex-wrap">
                        <input type="date" name="date" class="form-control w-auto mb-2" max="{{ today }}" required>
                        <button type="submit" class="btn btn-primary ms-2">Load</button>
                    </form>
                </div>
            </div>
        {% endif %}

    {% endwith %}
</div>

<script>
    const songId = {{ selected_song.id|default:"null" }};
    const playDate = "{{ selected_song.display_date|date:'Y-m-d'|default:'' }}";
</script>
<script src="{% static 'game/js/archive_play.js' %}?v=3.3"></script>
{% endblock %}

{% block extra_head %}
<style>
/* üèÜ Archive Leaderboard Styles */
.leaderboard-section {
    margin-top: 25px;
    text-align: center;
    width: 100%;
}

.toggle-leaderboard-btn {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.2));
    border: 2px solid #ffd700;
    color: #ffd700;
    padding: 14px 28px;
    border-radius: 15px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    box-shadow:
        0 4px 15px rgba(255, 215, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    min-width: 180px;
    outline: none;
    border-style: solid;
}

.toggle-leaderboard-btn:hover {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.3), rgba(255, 165, 0, 0.3));
    transform: translateY(-2px);
    box-shadow:
        0 6px 20px rgba(255, 215, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
}

.toggle-leaderboard-btn:active {
    transform: translateY(0);
}

.archive-leaderboard {
    margin-top: 20px;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.4), rgba(20, 20, 20, 0.6));
    border-radius: 15px;
    padding: 25px;
    backdrop-filter: blur(15px);
    border: 2px solid rgba(255, 215, 0, 0.2);
    box-shadow:
        0 8px 25px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.1);
    max-width: 500px;
    margin-left: auto;
    margin-right: auto;
}

.leaderboard-header {
    margin-bottom: 15px;
    color: #ffd700;
    font-weight: 600;
}

.leaderboard-header h5 {
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    color: #ffd700;
}

.leaderboard-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.leaderboard-row {
    display: grid;
    grid-template-columns: 50px 1fr 80px 80px;
    align-items: center;
    padding: 12px 16px;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    color: white;
    transition: all 0.3s ease;
}

.leaderboard-row:hover {
    background: rgba(255, 255, 255, 0.08);
}

/* üåü Gold Fantasy Styling for Hypothetical Entry */
.hypothetical-entry {
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.15)) !important;
    border: 2px solid rgba(255, 215, 0, 0.6);
    box-shadow:
        0 0 20px rgba(255, 215, 0, 0.4),
        inset 0 1px 0 rgba(255, 255, 255, 0.2);
    animation: goldGlow 2s ease-in-out infinite alternate;
    position: relative;
    overflow: hidden;
}

.hypothetical-entry::before {
    content: '‚ú®';
    position: absolute;
    left: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    animation: sparkle 1.5s ease-in-out infinite;
}

.hypothetical-entry::after {
    content: '‚ú®';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    animation: sparkle 1.5s ease-in-out infinite 0.5s;
}

.hypothetical-entry .username-col {
    color: #ffd700;
    font-weight: bold;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.hypothetical-entry .rank-col,
.hypothetical-entry .score-col,
.hypothetical-entry .time-col {
    color: #ffed4e;
    font-weight: 600;
}

@keyframes goldGlow {
    0% {
        box-shadow:
            0 0 20px rgba(255, 215, 0, 0.4),
            inset 0 1px 0 rgba(255, 255, 255, 0.2);
    }
    100% {
        box-shadow:
            0 0 30px rgba(255, 215, 0, 0.6),
            inset 0 1px 0 rgba(255, 255, 255, 0.3);
    }
}

@keyframes sparkle {
    0%, 100% {
        opacity: 0.6;
        transform: translateY(-50%) scale(1);
    }
    50% {
        opacity: 1;
        transform: translateY(-50%) scale(1.2);
    }
}

.rank-col {
    font-weight: bold;
    color: #ffd700;
}

.username-col {
    font-weight: 600;
    text-align: left;
}

.score-col, .time-col {
    font-weight: 500;
    text-align: center;
}

.leaderboard-loading {
    text-align: center;
    color: #ffd700;
    padding: 20px;
}

.leaderboard-error {
    text-align: center;
    color: #ff6b6b;
    padding: 20px;
}

/* üéØ Archive Navigation Styles */
.archive-navigation {
    margin-top: 25px;
    display: flex;
    justify-content: center;
    gap: 20px;
    flex-wrap: wrap;
}

.nav-date-btn {
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.15), rgba(0, 212, 255, 0.15));
    border: 2px solid #00d4ff;
    color: #00d4ff;
    padding: 12px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    min-width: 120px;
    justify-content: center;
    outline: none;
    box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
}

.nav-date-btn:hover:not(.disabled) {
    background: linear-gradient(135deg, rgba(0, 150, 255, 0.25), rgba(0, 212, 255, 0.25));
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0, 212, 255, 0.3);
}

.nav-date-btn:active:not(.disabled) {
    transform: translateY(0);
}

.nav-date-btn.disabled {
    background: rgba(100, 100, 100, 0.1);
    border-color: #666;
    color: #666;
    cursor: not-allowed;
    box-shadow: none;
}

.nav-date-btn i {
    font-size: 0.9rem;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .leaderboard-row {
        grid-template-columns: 40px 1fr 60px 60px;
        padding: 10px 12px;
        font-size: 0.9rem;
    }

    .hypothetical-entry::before,
    .hypothetical-entry::after {
        font-size: 1rem;
    }

    .archive-navigation {
        margin-top: 20px;
        gap: 15px;
    }

    .nav-date-btn {
        padding: 10px 16px;
        font-size: 0.85rem;
        min-width: 100px;
    }
}
</style>
{% endblock %}
